<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¢“å‚ã‚Šãƒ­ã‚°ï¼ˆå®Ÿé¨“ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#e5e7eb;
      --panel:#ffffff;
      --ink:#111827;
      --accent:#2563eb;
      --accent-soft:#eff6ff;
      --border:#d1d5db;
      --muted:#6b7280;
      --diary:#fef3c7;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top, #ffffff 0, #e5e7eb 45%, #d1d5db 100%);
      color:var(--ink);
      padding:1rem;
    }
    .app{
      max-width:960px;
      margin:0 auto;
    }
    h1{
      font-size:1.6rem;
      margin:0 0 0.25rem;
      display:flex;
      align-items:center;
      gap:0.4rem;
    }
    h1 span.icon{
      font-size:1.7rem;
    }
    .note{
      font-size:0.85rem;
      color:var(--muted);
      margin:0.25rem 0 0;
      line-height:1.6;
    }
    .card{
      background:var(--panel);
      border-radius:1rem;
      padding:1rem;
      box-shadow:0 10px 25px rgba(15,23,42,0.08);
      margin-bottom:1rem;
      border:1px solid rgba(148,163,184,0.35);
    }
    .header-card{
      margin-bottom:1.2rem;
      position:relative;
      overflow:hidden;
    }
    .header-card::before{
      content:"";
      position:absolute;
      inset:auto -40px 0;
      height:40px;
      background:linear-gradient(90deg, rgba(37,99,235,0.16), transparent);
    }
    .header-top{
      display:flex;
      justify-content:space-between;
      gap:1rem;
      align-items:flex-start;
    }
    .header-right{
      text-align:right;
      font-size:0.8rem;
      color:var(--muted);
    }
    .chip-row{
      margin-top:0.7rem;
      display:flex;
      flex-wrap:wrap;
      gap:0.4rem;
      font-size:0.75rem;
    }
    .chip{
      padding:0.18rem 0.6rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.8);
      background-color:#f9fafb;
      display:inline-flex;
      align-items:center;
      gap:0.25rem;
      white-space:nowrap;
    }
    .chip strong{
      font-weight:600;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ  */
    .form-grid{
      display:grid;
      grid-template-columns:1.1fr 0.9fr;
      gap:0.75rem;
    }
    @media (max-width:720px){
      .form-grid{
        grid-template-columns:1fr;
      }
    }
    label{
      font-size:0.8rem;
      display:block;
      margin-bottom:0.2rem;
      color:var(--muted);
    }
    input[type="text"],
    input[type="date"],
    textarea{
      width:100%;
      font-size:0.9rem;
      padding:0.45rem 0.55rem;
      border-radius:0.6rem;
      border:1px solid var(--border);
      margin-bottom:0.55rem;
      background:#f9fafb;
    }
    textarea{
      min-height:80px;
      resize:vertical;
    }
    input[type="file"]{
      font-size:0.8rem;
      margin-bottom:0.6rem;
    }
    input:focus,
    textarea:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(37,99,235,0.2);
      background:#ffffff;
    }
    button{
      appearance:none;
      border:none;
      border-radius:999px;
      padding:0.45rem 1.3rem;
      font-size:0.9rem;
      font-weight:600;
      background:var(--accent);
      color:white;
      cursor:pointer;
      box-shadow:0 6px 18px rgba(37,99,235,0.35);
      display:inline-flex;
      align-items:center;
      gap:0.4rem;
    }
    button span.btn-sub{
      font-size:0.7rem;
      opacity:0.9;
    }
    button:disabled{
      opacity:0.5;
      cursor:default;
      box-shadow:none;
    }

    .section-title{
      font-size:1rem;
      margin:0 0 0.6rem;
      display:flex;
      align-items:center;
      gap:0.4rem;
    }
    .section-title span.dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:var(--accent);
    }

    /* è¨˜éŒ²ã®ç¨®é¡ï¼ˆå‚æ‹ / æ—¥è¨˜ï¼‰ */
    .kind-row{
      display:flex;
      flex-wrap:wrap;
      gap:0.4rem;
      align-items:center;
      margin:0.2rem 0 0.5rem;
      font-size:0.8rem;
    }
    .kind-label{
      color:var(--muted);
      margin-right:0.2rem;
    }
    .kind-pill{
      display:inline-flex;
      align-items:center;
      gap:0.3rem;
      padding:0.2rem 0.6rem;
      border-radius:999px;
      border:1px solid var(--border);
      background:#f9fafb;
      cursor:pointer;
    }
    .kind-pill input{
      margin:0;
    }

    /* ãƒ­ã‚°è¡¨ç¤º */
    .logs{
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:0.75rem;
    }
    .log-item{
      position:relative;
      padding:0.75rem 0.75rem 0.6rem 0.8rem;
      border-radius:0.8rem;
      background:#f9fafb;
      border:1px solid rgba(209,213,219,0.9);
    }
    .log-item::before{
      content:"";
      position:absolute;
      inset:0 auto 0 0;
      width:4px;
      border-radius:999px;
      background:linear-gradient(to bottom, var(--accent), #38bdf8);
    }
    .log-header{
      display:flex;
      flex-wrap:wrap;
      gap:0.45rem;
      font-size:0.85rem;
      margin-bottom:0.25rem;
      align-items:center;
    }
    .log-date{
      padding:0.12rem 0.7rem;
      border-radius:999px;
      background:var(--accent-soft);
      font-weight:600;
      font-size:0.8rem;
    }
    .log-name{
      font-weight:600;
    }
    .log-target{
      font-size:0.8rem;
      color:var(--muted);
    }
    .kind-badge{
      padding:0.12rem 0.6rem;
      border-radius:999px;
      font-size:0.75rem;
      border:1px solid rgba(148,163,184,0.8);
      background:#f9fafb;
    }
    .kind-badge.visit{
      background:#ecfdf5;
      border-color:#bbf7d0;
    }
    .kind-badge.diary{
      background:var(--diary);
      border-color:#fbbf24;
    }

    .log-message{
      font-size:0.9rem;
      margin:0.35rem 0 0.15rem;
      white-space:pre-wrap;
      line-height:1.5;
    }
    .log-meta{
      font-size:0.7rem;
      color:var(--muted);
      margin-top:0.2rem;
    }
    .log-photo{
      margin-top:0.4rem;
    }
    .log-photo img{
      max-width:150px;
      border-radius:0.55rem;
      border:1px solid var(--border);
      display:block;
    }
    .empty{
      font-size:0.85rem;
      color:var(--muted);
    }

    /* å¯„ä»˜ãƒ–ãƒ­ãƒƒã‚¯ */
    .donation-block{
      margin-top:0.45rem;
      padding:0.45rem 0.55rem;
      border-radius:0.6rem;
      background:#f3f4f6;
      font-size:0.8rem;
    }
    .donation-summary{
      font-weight:600;
      margin-bottom:0.2rem;
    }
    .donation-line{
      margin:0.1rem 0;
    }
    .donation-block small{
      display:block;
      margin-top:0.2rem;
      color:var(--muted);
      font-size:0.75rem;
    }
    .donation-block button{
      margin-top:0.35rem;
      font-size:0.8rem;
      padding:0.25rem 0.9rem;
      background:#111827;
      box-shadow:none;
    }
    .donation-block button span.btn-sub{
      font-size:0.7rem;
      opacity:0.9;
    }

    /* å¯„ä»˜é›†è¨ˆã‚«ãƒ¼ãƒ‰ */
    #summaryContainer table{
      width:100%;
      border-collapse:collapse;
    }
    #summaryContainer th,
    #summaryContainer td{
      padding:0.25rem 0;
      font-size:0.8rem;
    }
    #summaryContainer th{
      text-align:left;
      color:var(--muted);
      border-bottom:1px solid rgba(209,213,219,0.8);
    }
    #summaryContainer td{
      border-bottom:1px dashed rgba(209,213,219,0.6);
    }

    /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
    .filter-row{
      display:flex;
      flex-wrap:wrap;
      gap:0.75rem;
      align-items:flex-end;
      margin-bottom:0.6rem;
      font-size:0.8rem;
    }
    .filter-block{
      flex:1 1 180px;
    }
    .filter-label{
      display:block;
      margin-bottom:0.15rem;
      color:var(--muted);
    }
    .filter-select,
    .filter-input{
      width:100%;
      padding:0.35rem 0.5rem;
      border-radius:999px;
      border:1px solid var(--border);
      background:#f9fafb;
      font-size:0.8rem;
    }
    .filter-select:focus,
    .filter-input:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(37,99,235,0.15);
      background:#ffffff;
    }

    @media (max-width:600px){
      body{
        padding:0.7rem;
      }
      .card{
        border-radius:0.8rem;
        padding:0.85rem;
      }
      .log-item{
        padding:0.7rem 0.7rem 0.55rem 0.75rem;
      }
    }
  </style>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

</head>
<body>
  <div class="app">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="card header-card">
      <div class="header-top">
        <div>
          <h1><span class="icon">ğŸ•Šï¸</span><span>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¢“å‚ã‚Šãƒ­ã‚°</span></h1>
          <p class="note">
            ã€Œèª°ãŒã©ã‚Œãã‚‰ã„è¡Œã£ã¦ã„ã‚‹ã‹ã€ã‚’ã‚„ã‚ã‚‰ã‹ãè¦‹ãˆã‚‹ã‚ˆã†ã«ã—ã¦ã€<br>
            è¡Œã‘ã‚‹æ—¥ã‚‚è¡Œã‘ãªã„æ—¥ã‚‚ã€ãã‚Œãã‚ŒãŒç„¡ç†ã®ãªã„ç¯„å›²ã§æ°—æŒã¡ã‚’æ®‹ã™ãŸã‚ã®ãƒ†ã‚¹ãƒˆç‰ˆã§ã™ã€‚<br>
            â€»å¯„ä»˜ã¯ã‚ãã¾ã§ã€Œãƒ¡ãƒ¢ã€ç”¨ã§ã€å®Ÿéš›ã®ãŠé‡‘ã®ã‚„ã‚Šã¨ã‚Šã¯ç¾é‡‘ã‚„æŒ¯è¾¼ãªã©åˆ¥ã®æ‰‹æ®µã§è¡Œã£ã¦ãã ã•ã„ã€‚
          </p>
        </div>
        <div class="header-right">
          <div>å‘½æ—¥ãƒ»ãŠç›†ã ã‘ã§ãªãã€</div>
          <div>ãµã¨æ€ã„å‡ºã—ãŸæ—¥ã‚‚ã€ã²ã¨ã“ã¨ã ã‘æ®‹ã›ã¾ã™ã€‚</div>
        </div>
      </div>
      <div class="chip-row">
        <span class="chip"><strong>âœ”</strong> ãŠå‚ã‚Šã®æ§˜å­ã‚’å†™çœŸã¤ãã§è¨˜éŒ²</span>
        <span class="chip"><strong>âœ”</strong> è¡Œã‘ãªã„æ—¥ã‚‚ã€Œå®¶ã‹ã‚‰ã®æ‰‹åˆã‚ã›ã€ã‚’æ—¥è¨˜ã«</span>
        <span class="chip"><strong>âœ”</strong> å¯„ä»˜ã¯ã€Œã‚„ã‚ŠãŸã„äººã ã‘ã€ãŒãƒ¡ãƒ¢</span>
      </div>
    </div>

    <!-- ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="card">
      <h2 class="section-title"><span class="dot"></span><span>æ–°ã—ã„è¨˜éŒ²ã‚’æ®‹ã™</span></h2>
      <form id="visitForm">
        <div class="form-grid">
          <div>
            <label for="visitDate">æ—¥ä»˜</label>
            <input type="date" id="visitDate" name="visit_date" required>

            <label for="visitorName">è¨˜éŒ²ã—ãŸäººã®åå‰</label>
            <input type="text" id="visitorName" name="visitor_name" placeholder="ä¾‹ï¼‰å¤ªéƒ" required>

            <label for="target">ã©ã®æ–¹ã®ãŠå¢“ãƒ»è¨˜éŒ²ã‹</label>
            <input type="text" id="target" name="target" placeholder="ä¾‹ï¼‰ç¥–çˆ¶ â—¯â—¯ ã®ãŠå¢“ï¼ç¥–æ¯ â–³â–³ ã®ã“ã¨">
            
            <div class="kind-row">
              <span class="kind-label">è¨˜éŒ²ã®ç¨®é¡</span>
              <label class="kind-pill">
                <input type="radio" name="kind" value="visit" checked>
                <span>å®Ÿéš›ã«ãŠå¢“ã«è¡Œã£ãŸ</span>
              </label>
              <label class="kind-pill">
                <input type="radio" name="kind" value="diary">
                <span>è¡Œã‘ãªã‹ã£ãŸæ—¥ã®ãƒ¡ãƒ¢ï¼ˆå®¶ã‹ã‚‰ã®æ‰‹åˆã‚ã›ï¼‰</span>
              </label>
            </div>

            <label for="message">ã²ã¨ã“ã¨ãƒ»ãƒ¡ãƒ¢</label>
            <textarea id="message" name="message" placeholder="ä¾‹ï¼‰æƒé™¤ã‚’ã—ã¦ã€ãŠèŠ±ã¨ãŠç·šé¦™ã‚’ãŠä¾›ãˆã—ã¾ã—ãŸã€‚"></textarea>
          </div>
          <div>
            <label for="photo">å†™çœŸï¼ˆå¢“çŸ³ã‚„ãŠèŠ±ãªã©ï¼1æšã¾ã§ï¼‰</label>
            <input type="file" id="photo" name="photo" accept="image/*">
            <p class="note" style="font-size:0.78rem; margin-top:0;">
              å†™çœŸã¯ã€Œä»Šã©ã‚“ãªæ§˜å­ã‹ã€ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚<br>
              æ—¥è¨˜ãƒ¢ãƒ¼ãƒ‰ï¼ˆå®¶ã‹ã‚‰ã®æ‰‹åˆã‚ã›ï¼‰ã®ã¨ãã¯ã€å†™çœŸãªã—ã§ã‚‚å¤§ä¸ˆå¤«ã§ã™ã€‚
            </p>
          </div>
        </div>
        <button type="submit" id="submitBtn">
          è¨˜éŒ²ã™ã‚‹
          <span class="btn-sub">ä»Šæ—¥ã®æ°—æŒã¡ã‚’æ®‹ã™</span>
        </button>
      </form>
    </div>

    <!-- å¯„ä»˜ã®é›†è¨ˆ -->
    <div class="card">
      <h2 class="section-title"><span class="dot"></span><span>å¯„ä»˜ã®ã–ã£ãã‚Šé›†è¨ˆï¼ˆãƒ¡ãƒ¢ï¼‰</span></h2>
      <div id="summaryContainer">
        <p class="empty">ã¾ã å¯„ä»˜ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      </div>
    </div>

    <!-- â˜… ãŠå‚ã‚Šãƒ»æ—¥è¨˜ã®å‚¾å‘ -->
    <div class="card">
      <h2 class="section-title"><span class="dot"></span><span>ãŠå‚ã‚Šãƒ»æ—¥è¨˜ã®ã–ã£ãã‚Šå‚¾å‘</span></h2>
      <div id="visitSummaryContainer">
        <p class="empty">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      </div>
    </div>

    <!-- ä¸€è¦§ -->
    <div class="card">
      <h2 class="section-title"><span class="dot"></span><span>ã“ã‚Œã¾ã§ã®è¨˜éŒ²</span></h2>

      <!-- çµã‚Šè¾¼ã¿ -->
      <div class="filter-row">
        <div class="filter-block">
          <span class="filter-label">è¡¨ç¤ºã™ã‚‹ç¨®é¡</span>
          <select id="filterKind" class="filter-select">
            <option value="all">ã™ã¹ã¦</option>
            <option value="visit">ãŠå¢“å‚ã‚Šã ã‘</option>
            <option value="diary">æ—¥è¨˜ï¼ˆå®¶ã‹ã‚‰ã®æ‰‹åˆã‚ã›ï¼‰ã ã‘</option>
          </select>
        </div>
        <div class="filter-block">
          <span class="filter-label">ã€Œã©ã®æ–¹ã®è¨˜éŒ²ã‹ã€ã§çµã‚Šè¾¼ã¿</span>
          <input id="filterTarget" class="filter-input" type="text" placeholder="ä¾‹ï¼‰ç¥–çˆ¶ï¼ç¥–æ¯ï¼â—¯â—¯ ãªã©ä¸€éƒ¨ã®æ–‡å­—ã§OK">
        </div>
      </div>

      <div id="logsContainer">
        <p class="empty">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      </div>
    </div>
  </div>

  <script>
    // â˜… LIFF è¨­å®šï¼ˆLINEã§å‹•ã‹ã™ã¨ãç”¨ï¼‰
    // LINE Developers ã§ç™ºè¡Œã•ã‚Œã‚‹ LIFF ID ã‚’ã‚ã¨ã§ã“ã“ã«å…¥ã‚Œã‚‹
    const LIFF_ID = "2008658750-28D6NP3P";

    async function initLiffIfAvailable() {
      // ãƒ­ãƒ¼ã‚«ãƒ«ã§ file:// ã‹ã‚‰é–‹ã„ã¦ã„ã‚‹ã¨ãã¯ä½•ã‚‚ã—ãªã„
      if (location.protocol === "file:") {
        return;
      }
      // LIFF SDK ãŒèª­ã¿è¾¼ã‚ã¦ã„ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
      if (typeof liff === "undefined") {
        return;
      }
      try {
        await liff.init({ liffId: LIFF_ID });

        // LINEã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã‘ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ã•ã›ã‚‹
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾—ã—ã¦åå‰æ¬„ã«ã‚»ãƒƒãƒˆ
        const profile = await liff.getProfile();  // displayName ç­‰ãŒå–ã‚Œã‚‹
        const nameInput = document.getElementById("visitorName");
        if (nameInput && !nameInput.value) {
          nameInput.value = profile.displayName || "";
        }
      } catch (e) {
        console.error("LIFF init error:", e);
        // å¤±æ•—ã—ã¦ã‚‚ç”»é¢è‡ªä½“ã¯æ™®é€šã®Webã‚¢ãƒ—ãƒªã¨ã—ã¦å‹•ãã®ã§æ”¾ç½®ã§OK
      }
    }

    const API_BASE = "http://127.0.0.1:8000";

    // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ã¦ãŠãï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»é›†è¨ˆç”¨ï¼‰
    let gLogs = [];
    let gDonations = [];

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ã‚»ãƒƒãƒˆ
    function setToday() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      document.getElementById("visitDate").value = `${yyyy}-${mm}-${dd}`;
    }

    // å¯„ä»˜ã®ã–ã£ãã‚Šé›†è¨ˆï¼ˆäººã”ã¨ï¼‰
    function updateSummary(donations) {
      const box = document.getElementById("summaryContainer");
      if (!box) return;

      if (!donations || donations.length === 0) {
        box.innerHTML = '<p class="empty">ã¾ã å¯„ä»˜ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
      }

      let totalAmount = 0;
      const byDonor = {};

      donations.forEach(d => {
        const amount = Number(d.amount) || 0;
        totalAmount += amount;
        const name = d.donor_name || "ï¼ˆåå‰ãªã—ï¼‰";
        if (!byDonor[name]) {
          byDonor[name] = { name, total: 0, count: 0 };
        }
        byDonor[name].total += amount;
        byDonor[name].count += 1;
      });

      const donors = Object.values(byDonor).sort((a, b) => b.total - a.total);

      let html = '';
      html += `<p style="font-size:0.85rem; margin:0 0 0.5rem;">
åˆè¨ˆå¯„ä»˜é¡ï¼ˆãƒ¡ãƒ¢ï¼‰ï¼š${totalAmount.toLocaleString()} å†† ï¼ ä»¶æ•°ï¼š${donations.length} ä»¶
</p>`;

      html += `<table>
<thead>
<tr>
  <th style="text-align:left;">åå‰</th>
  <th style="text-align:right;">ä»¶æ•°</th>
  <th style="text-align:right;">åˆè¨ˆé¡</th>
  <th style="text-align:right;">1ä»¶ã‚ãŸã‚Šç›®å®‰</th>
</tr>
</thead>
<tbody>`;

      donors.forEach(p => {
        const avg = p.total && p.count ? Math.round(p.total / p.count) : 0;
        html += `<tr>
  <td>${p.name}</td>
  <td style="text-align:right;">${p.count}</td>
  <td style="text-align:right;">${p.total.toLocaleString()} å††</td>
  <td style="text-align:right;">${avg.toLocaleString()} å††</td>
</tr>`;
      });

      html += `</tbody></table>`;

      box.innerHTML = html;
    }

    // â˜… ãŠå‚ã‚Šãƒ»æ—¥è¨˜ã®å‚¾å‘ï¼ˆäººã”ã¨ï¼å¯¾è±¡ã”ã¨ï¼ç¨®åˆ¥ï¼‰
    function updateVisitSummary(logs) {
      const box = document.getElementById("visitSummaryContainer");
      if (!box) return;

      if (!logs || logs.length === 0) {
        box.innerHTML = '<p class="empty">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
      }

      const total = logs.length;
      const byPerson = {};
      const byTarget = {};
      const byKind = { visit: 0, diary: 0 };

      logs.forEach(item => {
        const name = item.visitor_name || "ï¼ˆåå‰ãªã—ï¼‰";
        const target = item.target || "å…ˆç¥–ã®ãŠå¢“";
        const kind = item.kind || "visit";

        byPerson[name] = (byPerson[name] || 0) + 1;
        byTarget[target] = (byTarget[target] || 0) + 1;
        if (!byKind[kind]) byKind[kind] = 0;
        byKind[kind] += 1;
      });

      const persons = Object.entries(byPerson)
        .map(([name, count]) => ({ name, count }))
        .sort((a, b) => b.count - a.count);

      const targets = Object.entries(byTarget)
        .map(([name, count]) => ({ name, count }))
        .sort((a, b) => b.count - a.count);

      const visitCount = byKind.visit || 0;
      const diaryCount = byKind.diary || 0;

      let html = "";
      html += `<p style="font-size:0.85rem; margin:0 0 0.6rem;">
å…¨ä½“ï¼š${total} ä»¶ï¼ˆãŠå¢“å‚ã‚Š ${visitCount} ä»¶ ï¼ æ—¥è¨˜ ${diaryCount} ä»¶ï¼‰ã§ã™ã€‚ã‚ãã¾ã§ã€Œå‚¾å‘ã€ã‚’è¦‹ã‚‹ãŸã‚ã®ãƒ¡ãƒ¢ã§ã™ã€‚
</p>`;

      html += `<div style="display:flex; flex-wrap:wrap; gap:1.2rem; font-size:0.8rem;">`;

      // äººã”ã¨
      html += `<div style="flex:1 1 200px;">
  <div style="font-weight:600; margin-bottom:0.3rem;">äººã”ã¨ã®è¨˜éŒ²å›æ•°</div>`;
      html += `<ul style="list-style:none; padding:0; margin:0;">`;
      persons.forEach(p => {
        const ratio = total ? Math.round((p.count / total) * 100) : 0;
        html += `<li style="margin:0.12rem 0;">
  <span>${p.name}</span>
  <span style="float:right;">${p.count} ä»¶ï¼ˆç´„ ${ratio}%ï¼‰</span>
</li>`;
      });
      html += `</ul></div>`;

      // å¯¾è±¡ã”ã¨
      html += `<div style="flex:1 1 200px;">
  <div style="font-weight:600; margin-bottom:0.3rem;">ã©ã®æ–¹ã®è¨˜éŒ²ãŒå¤šã„ã‹</div>`;
      html += `<ul style="list-style:none; padding:0; margin:0;">`;
      targets.forEach(t => {
        const ratio = total ? Math.round((t.count / total) * 100) : 0;
        html += `<li style="margin:0.12rem 0;">
  <span>${t.name}</span>
  <span style="float:right;">${t.count} ä»¶ï¼ˆç´„ ${ratio}%ï¼‰</span>
</li>`;
      });
      html += `</ul></div>`;

      html += `</div>`;

      box.innerHTML = html;
    }

    // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’èª­ã¿å–ã£ã¦ä¸€è¦§ã‚’æç”»
    function renderLogs() {
      const container = document.getElementById("logsContainer");
      const filterKindEl = document.getElementById("filterKind");
      const filterTargetEl = document.getElementById("filterTarget");

      if (!container) return;

      const kindFilter = filterKindEl ? filterKindEl.value : "all";
      const targetTextRaw = filterTargetEl ? filterTargetEl.value : "";
      const targetText = targetTextRaw.trim();

      let logs = gLogs.slice();  // ã‚³ãƒ”ãƒ¼

      // ç¨®é¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      if (kindFilter !== "all") {
        logs = logs.filter(item => {
          const k = item.kind || "visit";
          return k === kindFilter;
        });
      }

      // å¯¾è±¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰
      if (targetText) {
        const q = targetText.toLowerCase();
        logs = logs.filter(item => {
          const t = (item.target || "å…ˆç¥–ã®ãŠå¢“").toLowerCase();
          return t.includes(q);
        });
      }

      if (!logs.length) {
        container.innerHTML = "<p class=\"empty\">ï¼ˆã“ã®æ¡ä»¶ã«åˆã†è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰</p>";
        return;
      }

      // visit_id ã”ã¨ã«å¯„ä»˜ã‚’ã¾ã¨ã‚ã‚‹
      const donationsByVisit = {};
      gDonations.forEach(d => {
        const vid = d.visit_id;
        if (!donationsByVisit[vid]) {
          donationsByVisit[vid] = [];
        }
        donationsByVisit[vid].push(d);
      });

      const ul = document.createElement("ul");
      ul.className = "logs";

      logs.forEach(item => {
        const li = document.createElement("li");
        li.className = "log-item";

        const kind = item.kind || "visit";
        const target = item.target || "å…ˆç¥–ã®ãŠå¢“";
        const kindLabel = kind === "diary" ? "å®¶ã‹ã‚‰ã®æ‰‹åˆã‚ã›ãƒ»æ—¥è¨˜" : "ãŠå¢“å‚ã‚Š";
        const kindClass = kind === "diary" ? "kind-badge diary" : "kind-badge visit";

        const header = document.createElement("div");
        header.className = "log-header";
        header.innerHTML = `
          <span class="log-date">${item.visit_date}</span>
          <span class="log-name">${item.visitor_name}</span>
          <span class="log-target">${target}</span>
          <span class="${kindClass}">${kindLabel}</span>
        `;

        const msg = document.createElement("div");
        msg.className = "log-message";
        msg.textContent = item.message || "ï¼ˆãƒ¡ãƒ¢ãªã—ï¼‰";

        const meta = document.createElement("div");
        meta.className = "log-meta";
        meta.textContent = `ç™»éŒ²æ—¥æ™‚ï¼š${item.created_at}ã€€IDï¼š${item.id.substring(0, 8)}â€¦`;

        li.appendChild(header);
        li.appendChild(msg);

        if (item.photo_url) {
          const photoDiv = document.createElement("div");
          photoDiv.className = "log-photo";
          const img = document.createElement("img");
          img.src = API_BASE + item.photo_url;
          img.alt = "ãŠå‚ã‚Šæ™‚ã®å†™çœŸ";
          photoDiv.appendChild(img);
          li.appendChild(photoDiv);
        }

        // å®Ÿéš›ã«ãŠå¢“ã«è¡Œã£ãŸãƒ­ã‚°ã«ã ã‘å¯„ä»˜ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‡ºã™
        if (kind === "visit") {
          const donateBlock = document.createElement("div");
          donateBlock.className = "donation-block";

          const list = donationsByVisit[item.id] || [];
          const info = document.createElement("div");

          if (!list.length) {
            info.textContent = "ã“ã®ãŠå‚ã‚Šã¸ã®å¯„ä»˜ã¯ã¾ã è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ï¼ˆã“ã“ã¯ãƒ¡ãƒ¢ç”¨ã§ã€å®Ÿéš›ã®ãŠé‡‘ã®ã‚„ã‚Šã¨ã‚Šã¯åˆ¥ã§è¡Œã£ã¦ãã ã•ã„ï¼‰";
          } else {
            let total = 0;
            list.forEach(d => {
              total += Number(d.amount) || 0;
            });

            const summary = document.createElement("div");
            summary.className = "donation-summary";
            summary.textContent = `ã“ã®ãŠå‚ã‚Šã¸ã®å¯„ä»˜ åˆè¨ˆï¼š${total.toLocaleString()} å††ï¼ˆ${list.length} ä»¶ï¼‰`;
            info.appendChild(summary);

            list.forEach(d => {
              const line = document.createElement("div");
              line.className = "donation-line";
              const amt = (Number(d.amount) || 0).toLocaleString();
              const nm = d.donor_name || "åŒ¿å";
              const msg = d.message ? ` ï¼ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼š${d.message}` : "";
              line.textContent = `ãƒ»${nm}ï¼š${amt} å††${msg}`;
              info.appendChild(line);
            });
          }

          const btn = document.createElement("button");
          btn.type = "button";
          btn.innerHTML = `å¯„ä»˜ã‚’è¨˜éŒ²ã™ã‚‹<span class="btn-sub">ï¼ˆãƒ¡ãƒ¢ï¼‰</span>`;
          btn.addEventListener("click", () => handleDonate(item));

          donateBlock.appendChild(info);
          const small = document.createElement("small");
          small.textContent = "â€»ã“ã“ã«æ®‹ã™ã®ã¯ã€Œå¯„ä»˜ã—ãŸã¤ã‚‚ã‚Šã€ã®ãƒ¡ãƒ¢ã ã‘ã§ã™ã€‚å®Ÿéš›ã®é€é‡‘ã¯åˆ¥ã®æ‰‹æ®µã§ãŠé¡˜ã„ã—ã¾ã™ã€‚";
          donateBlock.appendChild(small);
          donateBlock.appendChild(btn);

          li.appendChild(donateBlock);
        }

        li.appendChild(meta);
        ul.appendChild(li);
      });

      container.innerHTML = "";
      container.appendChild(ul);
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿æŒ â†’ ã‚µãƒãƒªæ›´æ–° â†’ ä¸€è¦§æç”»
    async function loadLogs() {
      const container = document.getElementById("logsContainer");
      container.innerHTML = "<p class=\"empty\">èª­ã¿è¾¼ã¿ä¸­â€¦</p>";

      try {
        const [resVisits, resDonations] = await Promise.all([
          fetch(API_BASE + "/api/visits"),
          fetch(API_BASE + "/api/donations"),
        ]);

        if (!resVisits.ok || !resDonations.ok) {
          throw new Error("HTTP " + resVisits.status + " / " + resDonations.status);
        }

        gLogs = await resVisits.json();
        gDonations = await resDonations.json();

        updateSummary(gDonations);
        updateVisitSummary(gLogs);
        renderLogs();

      } catch (e) {
        console.error(e);
        container.innerHTML = "<p class=\"empty\">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>";
      }
    }

    async function handleDonate(log) {
      try {
        const donor = window.prompt("å¯„ä»˜ã™ã‚‹æ–¹ã®ãŠåå‰ï¼ˆãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã§ã‚‚å¯ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š");
        if (!donor) {
          return;
        }
        const amountStr = window.prompt("å¯„ä»˜ã—ãŸã„é‡‘é¡ï¼ˆå††ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚â€»ã“ã“ã§ã¯ãƒ¡ãƒ¢ã ã‘ã§ã€å®Ÿéš›ã®é€é‡‘ã¯åˆ¥æ‰‹æ®µã§è¡Œã£ã¦ãã ã•ã„ï¼š");
        if (!amountStr) {
          return;
        }
        const amount = parseInt(amountStr, 10);
        if (!amount || amount <= 0) {
          alert("é‡‘é¡ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
          return;
        }
        const msg = window.prompt("ã²ã¨ã“ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ï¼ˆç©ºã§ã‚‚OKï¼‰") || "";

        const fd = new FormData();
        fd.append("visit_id", log.id);
        fd.append("donor_name", donor);
        fd.append("amount", String(amount));
        fd.append("message", msg);

        const res = await fetch(API_BASE + "/api/donations", {
          method: "POST",
          body: fd,
        });

        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        await loadLogs();
        alert("å¯„ä»˜ã®è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ï¼ˆå®Ÿéš›ã®ãŠé‡‘ã®ã‚„ã‚Šã¨ã‚Šã¯åˆ¥ã§ãŠé¡˜ã„ã—ã¾ã™ï¼‰");

      } catch (e) {
        console.error(e);
        alert("å¯„ä»˜ã®è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }
    }

    async function handleSubmit(e) {
      e.preventDefault();
      const btn = document.getElementById("submitBtn");
      btn.disabled = true;

      try {
        const formEl = document.getElementById("visitForm");
        const fd = new FormData(formEl);

        const res = await fetch(API_BASE + "/api/visits", {
          method: "POST",
          body: fd
        });

        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        document.getElementById("message").value = "";
        document.getElementById("photo").value = "";
        await loadLogs();

        alert("è¨˜éŒ²ã—ã¾ã—ãŸã€‚");

      } catch (e2) {
        console.error(e2);
        alert("è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      } finally {
        btn.disabled = false;
      }
    }

    // åˆæœŸåŒ–
    document.getElementById("visitForm").addEventListener("submit", handleSubmit);
    const filterKindEl = document.getElementById("filterKind");
    const filterTargetEl = document.getElementById("filterTarget");
    filterKindEl.addEventListener("change", renderLogs);
    filterTargetEl.addEventListener("input", renderLogs);

    setToday();
    loadLogs();

    // â˜… LINE ã‹ã‚‰é–‹ã‹ã‚ŒãŸå ´åˆã¯ LIFF ã‚’åˆæœŸåŒ–ï¼ˆãƒ­ãƒ¼ã‚«ãƒ« file:// ã®ã¨ãã¯ä½•ã‚‚ã—ãªã„ï¼‰
    initLiffIfAvailable();
  </script>
</body>
</html>
